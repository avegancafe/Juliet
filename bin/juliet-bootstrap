#! /bin/bash

source ~/.config/Juliet/_util.bash

# Global flags
YES_ALL="false"
NO_ALL="false"
ENABLED_STEPS=()
SKIPPED_STEPS=()
SSH_EMAIL=""

show-help() {
  cat << 'EOF'
Usage: juliet-bootstrap [OPTIONS]

Options:
  -y, --yes              Accept all prompts
  -n, --no               Decline all prompts
  --enable=STEPS         Only run these steps (comma-separated)
  --skip=STEPS           Skip these steps (comma-separated)
  --ssh-email=EMAIL      Email for SSH key generation
  -h, --help             Show this help message

Steps: brew, dnf, fish, ssh

Examples:
  juliet-bootstrap -y                    # Accept all prompts
  juliet-bootstrap -y --skip=brew,dnf    # All except brew and dnf
  juliet-bootstrap --enable=fish,ssh     # Only fish and ssh
  juliet-bootstrap --enable=ssh --ssh-email=test@example.com
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -y|--yes)
      YES_ALL="true"
      shift
      ;;
    -n|--no)
      NO_ALL="true"
      shift
      ;;
    --enable=*)
      IFS=',' read -ra ENABLED_STEPS <<< "${1#*=}"
      shift
      ;;
    --skip=*)
      IFS=',' read -ra SKIPPED_STEPS <<< "${1#*=}"
      shift
      ;;
    --ssh-email=*)
      SSH_EMAIL="${1#*=}"
      shift
      ;;
    -h|--help)
      show-help
      exit 0
      ;;
    *)
      warn "Unknown option: $1"
      show-help
      exit 1
      ;;
  esac
done

# Check if a step should run based on --enable and --skip flags
should-run-step() {
  local step="$1"

  # If --enable was used, only run if step is in the list
  if [[ ${#ENABLED_STEPS[@]} -gt 0 ]]; then
    [[ " ${ENABLED_STEPS[*]} " =~ " $step " ]] && return 0 || return 1
  fi

  # If --skip was used, skip if step is in the list
  if [[ " ${SKIPPED_STEPS[*]} " =~ " $step " ]]; then
    return 1
  fi

  return 0
}

# Determine whether to prompt or auto-answer based on flags
should-confirm() {
  local step="$1"
  local prompt="$2"

  # Step was explicitly enabled via --enable
  if [[ ${#ENABLED_STEPS[@]} -gt 0 ]] && [[ " ${ENABLED_STEPS[*]} " =~ " $step " ]]; then
    return 0
  fi

  # Global yes/no flags
  [[ "$YES_ALL" == "true" ]] && return 0
  [[ "$NO_ALL" == "true" ]] && return 1

  # Interactive prompt
  gum confirm "$prompt"
}

# OS Detection
is-fedora() {
  [ -f /etc/fedora-release ]
}

is-macos() {
  [[ "$OSTYPE" == "darwin"* ]]
}

setup-git() {
  mkdir -p ~/.config/local
  [[ ! -f ~/.config/local/gitconfig ]] && cp ~/.config/Juliet/.gitconfig__local ~/.config/local/gitconfig
}

update-juliet() {
  WORKDIR="$HOME/.config/Juliet"
  if [ -d "$WORKDIR" ]; then
    cd "$WORKDIR"

    if ! git diff --quiet; then
      warn "Warning: There are unstaged changes in ~/.config/Juliet. Skipping updating Juliet."
      cd - > /dev/null
      return
    fi


    DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)

    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    if [ "$CURRENT_BRANCH" = "$DEFAULT_BRANCH" ]; then
      git pull
    else
      warn "Warning: ~/.config/Juliet is not on the default branch. Current branch: $CURRENT_BRANCH"
      return
    fi

    cd - > /dev/null
  else
    log "Error: Juliet directory not found at $WORKDIR"
  fi
}


setup-brew() {
  should-run-step "brew" || return

  if ! command -v brew &> /dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

    # Set up brew path based on OS
    if [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
      # Linux
      BREW_SHELLENV='eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"'
      if ! grep -q "linuxbrew" "$HOME/.bashrc" 2>/dev/null; then
        echo "$BREW_SHELLENV" >> "$HOME/.bashrc"
      fi
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    else
      # macOS
      echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "$HOME/.zprofile"
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  fi

  if ! command -v gum &> /dev/null; then
    brew install gum
  fi

  if should-confirm "brew" "Would you like to brew bundle?"; then
    brew bundle --file ~/.config/Juliet/Brewfile
  fi
}

setup-cargo() {
  if ! command -v cargo &> /dev/null; then
    rustup-init
  fi
}

setup-dnf() {
  should-run-step "dnf" || return

  if ! command -v gum &> /dev/null; then
    sudo dnf install -y gum
  fi

  DNFFILE="$HOME/.config/Juliet/DNFfile"
  if [[ ! -f "$DNFFILE" ]]; then
    warn "DNFfile not found at $DNFFILE"
    return
  fi

  if should-confirm "dnf" "Would you like to install DNF packages?"; then
    # Enable COPR repos first
    while IFS= read -r line || [[ -n "$line" ]]; do
      # Skip empty lines and comments
      [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
      # Handle COPR repos
      if [[ "$line" =~ ^copr[[:space:]]+ ]]; then
        repo="${line#copr }"
        if ! dnf copr list 2>/dev/null | grep -q "$repo"; then
          log "Enabling COPR: $repo"
          sudo dnf copr enable -y "$repo"
        fi
      fi
    done < "$DNFFILE"

    # Collect packages
    packages=()
    while IFS= read -r line || [[ -n "$line" ]]; do
      # Skip empty lines, comments, and copr lines
      [[ -z "$line" || "$line" =~ ^[[:space:]]*# || "$line" =~ ^copr[[:space:]]+ ]] && continue
      packages+=("$line")
    done < "$DNFFILE"

    # Install packages
    if [[ ${#packages[@]} -gt 0 ]]; then
      log "Installing ${#packages[@]} packages..."
      sudo dnf install -y "${packages[@]}"
    fi
  fi
}

os-specific-install() {
  log "Checking for os-specific dependencies..."
  if is-fedora; then
    log "Detected Fedora, setting up DNF packages..."
    setup-dnf
  fi
}

symlink-dotfiles() {
  stow --target=$HOME --dir=$HOME/.config/Juliet/symlinked home
  stow --target=$HOME/.config --dir=$HOME/.config/Juliet/symlinked config
  stow --target=$HOME/.local/state --dir=$HOME/.config/Juliet/symlinked local-state
}

setup-ssh() {
  should-run-step "ssh" || return

  if [[ ! -d $HOME/.ssh ]]; then
    mkdir $HOME/.ssh
    chmod 700 $HOME/.ssh
  fi

  if [[ ! -f $HOME/.ssh/id_ed25519 ]]; then
    if should-confirm "ssh" "Looks like you don't have an SSH key, would you like to generate one?"; then
      local email="${SSH_EMAIL:-}"
      if [[ -z "$email" ]]; then
        email=$(gum input --prompt "What is your email for your ssh key? " --placeholder "your_email@example.com")
      fi
      ssh-keygen -t ed25519 -C "$email" -f $HOME/.ssh/id_ed25519
    fi
  fi
}

setup-fzf() {
  if ! command -v fzf &> /dev/null; then
    /opt/homebrew/opt/fzf/install
  fi
}

setup-fish() {
  should-run-step "fish" || return

  mkdir -p ~/.config/fish

  FISH_PATH="$(command -v fish)"
  if [[ -z "$FISH_PATH" ]]; then
    warn "fish not found, skipping fish setup"
    return
  fi

  if should-confirm "fish" "Would you like to do a full fish install?"; then
    if ! grep -q "$FISH_PATH" /etc/shells 2>/dev/null; then
      log "Adding $FISH_PATH to /etc/shells..."
      sudo bash -c "echo '$FISH_PATH' >> /etc/shells"
    fi

    if [[ "$SHELL" != "$FISH_PATH" ]]; then
      log "Setting fish to default shell..."
      chsh -s "$FISH_PATH" "$(whoami)"
    fi
  fi
}

setup-gpg() {
  if [[ ! -d $HOME/.gnupg ]]; then
    mkdir ~/.gnupg
    touch ~/.gnupg/gpg-agent.conf
    echo "pinentry-program /usr/local/bin/pinentry-mac" >> ~/.gnupg/gpg-agent.conf
  fi
}

setup-rust() {
  if ! command -v stylua &> /dev/null; then
    cargo install stylua
  fi

  if is-macos && ! command -v silicon &> /dev/null; then
    cargo install silicon
  fi
}

setup-python() {
  if ! command -v poetry &> /dev/null; then
    curl -sSL https://install.python-poetry.org | python3 -
  fi

  if is-macos && ! command -v md2pdf &> /dev/null; then
    pip3 install md2pdf
  fi
}

setup-niri() {
  if ! command -v niri &> /dev/null; then
    return
  fi

  # Bind DMS to niri session (only runs with niri, not other DEs)
  if command -v dms &> /dev/null; then
    if ! systemctl --user list-dependencies niri.service 2>/dev/null | grep -q dms.service; then
      log "Binding DMS to niri session..."
      systemctl --user add-wants niri.service dms.service
    fi
  fi
}

setup-sddm() {
  if ! is-fedora; then
    return
  fi

  if ! command -v sddm &> /dev/null; then
    return
  fi

  THEME_SRC="$HOME/.config/Juliet/etc/sddm-themes/juliet"
  THEME_DEST="/usr/share/sddm/themes/juliet"

  if [[ ! -d "$THEME_SRC" ]]; then
    return
  fi

  # Always copy/update theme to system directory
  log "Installing Juliet SDDM theme..."
  sudo rm -rf "$THEME_DEST"
  sudo cp -r "$THEME_SRC" "$THEME_DEST"
  sudo cp "$HOME/.config/Juliet/etc/wallpaper/my-neighbor-totoro-sunflowers.png" "$THEME_DEST/background.png"
  sudo chmod -R 755 "$THEME_DEST"
  sudo find "$THEME_DEST" -type f -exec chmod 644 {} \;

  # Set theme in SDDM config
  SDDM_CONF="/etc/sddm.conf.d/juliet.conf"
  if [[ ! -f "$SDDM_CONF" ]]; then
    log "Configuring SDDM to use Juliet theme..."
    sudo tee "$SDDM_CONF" > /dev/null << 'EOF'
[Theme]
Current=juliet
EOF
  fi
}

setup-icons() {
  if ! is-fedora; then
    return
  fi

  ICONS_DIR="$HOME/.local/share/icons"
  ICON_PACK_DIR="$ICONS_DIR/gruvbox-plus-icon-pack"

  mkdir -p "$ICONS_DIR"

  if [[ ! -d "$ICON_PACK_DIR" ]]; then
    log "Installing Gruvbox Plus icon pack..."
    git clone https://github.com/SylEleuth/gruvbox-plus-icon-pack.git "$ICON_PACK_DIR"
  else
    log "Updating Gruvbox Plus icon pack..."
    git -C "$ICON_PACK_DIR" pull
  fi

  # Create symlinks for icon themes
  if [[ ! -L "$ICONS_DIR/Gruvbox-Plus-Dark" ]]; then
    ln -s "$ICON_PACK_DIR/Gruvbox-Plus-Dark" "$ICONS_DIR/Gruvbox-Plus-Dark"
  fi
  if [[ ! -L "$ICONS_DIR/Gruvbox-Plus-Light" ]]; then
    ln -s "$ICON_PACK_DIR/Gruvbox-Plus-Light" "$ICONS_DIR/Gruvbox-Plus-Light"
  fi
}

setup-claude-code() {
  if ! command -v claude &> /dev/null; then
    curl -fsSL https://claude.ai/install.sh | bash
  fi

  # Define marketplaces to add (try adding official ones in case they're not registered by default)
  # Format: "name:id" pairs (bash 3.2 compatible)
  marketplaces=(
    "superpowers-marketplace:obra/superpowers-marketplace"
    "claude-code-plugins:anthropics/claude-code-plugins"
    "claude-code-workflows:anthropics/claude-code-workflows"
    "claude-plugins-official:anthropics/claude-plugins-official"
  )

  # Add marketplaces if not already registered
  for marketplace_pair in "${marketplaces[@]}"; do
    marketplace_name="${marketplace_pair%%:*}"
    marketplace_id="${marketplace_pair#*:}"
    if ! claude plugin marketplace list 2>/dev/null | grep -Fq "$marketplace_name"; then
      log "Adding $marketplace_name marketplace..."
      # Try to add, but don't fail if it's already registered by default
      claude plugin marketplace add "$marketplace_id" 2>/dev/null || true
    else
      log "$marketplace_name already registered"
    fi
  done

  # Define plugins to install (excluding ralph-loop)
  plugins=(
    "superpowers@superpowers-marketplace"
    "frontend-design@claude-code-plugins"
    "python-development@claude-code-workflows"
    "kubernetes-operations@claude-code-workflows"
    "cloud-infrastructure@claude-code-workflows"
    "shell-scripting@claude-code-workflows"
    "backend-development@claude-code-workflows"
    "context7@claude-plugins-official"
    "pyright-lsp@claude-plugins-official"
    "typescript-lsp@claude-plugins-official"
    "sentry@claude-plugins-official"
    "linear@claude-plugins-official"
    "Notion@claude-plugins-official"
    "playwright@claude-plugins-official"
  )

  # Install plugins if not already installed
  for plugin in "${plugins[@]}"; do
    if ! claude plugin list 2>/dev/null | grep -Fq "$plugin"; then
      log "Installing $plugin..."
      claude plugin install "$plugin" || warn "Failed to install $plugin"
    else
      log "$plugin already installed"
    fi
  done
}

rlog "Setting up git..."
setup-git
rlog "Updating Juliet repository..."
update-juliet
rlog "Installing OS-specific packages..."
os-specific-install
rlog "Setting up Homebrew..."
setup-brew
rlog "Setting up Cargo..."
setup-cargo
log "Symlinking dotfiles..."
symlink-dotfiles
log "Setting up ssh..."
setup-ssh
log "Installing fzf..."
setup-fzf
log "Installing fish..."
setup-fish
log "Installing gpg..."
setup-gpg
rlog "Installing rust dependencies..."
setup-rust
rlog "Setting up python..."
setup-python
log "Setting up niri..."
setup-niri
log "Setting up SDDM theme..."
setup-sddm
log "Setting up icon themes..."
setup-icons
rlog "Setting up Claude Code..."
setup-claude-code

log "Done!"
