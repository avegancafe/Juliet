#! /bin/bash

source ~/.config/Juliet/_util.bash

link_file() {
  DESTINATION=${2:-~}
  [[ ! -f $DESTINATION/$1 ]] && ln -sfv ~/.config/Juliet/$1 $DESTINATION
}

link_dir() {
  DESTINATION=${2:-~}
  [[ ! -d $DESTINATION/$1 ]] && ln -sfv ~/.config/Juliet/$1 $DESTINATION
}


setup_git() {
  link_file .gitconfig
  link_file .gitmessage
  [[ ! -f ~/.gitconfig__local ]] && cp ~/.config/Juliet/.gitconfig__local ~
}

setup_dependencies() {
  if ! command -v brew &> /dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
  brew bundle --file ~/.config/Juliet/Brewfile

  if ! command -v cargo &> /dev/null; then
    rustup-init
  fi

  link_dir .hammerspoon
  link_dir karabiner ~/.config
  link_dir ripgrep ~/.config
  link_file .prettierrc
  link_file .fdignore
  link_file .workspaces
  link_file .psqlrc
  link_file .pgclirc
}

setup_fzf() {
  if ! command -v fzf &> /dev/null; then
    /opt/homebrew/opt/fzf/install
  fi
}

setup_vim() {
  link_dir nvim ~/.config
  link_file .stylua.toml
}

setup_fish() {
  sudo bash -c "echo '/opt/homebrew/bin/fish' >> /etc/shells"
  mkdir -p ~/.config/fish
  [[ ! -f ~/.config/fish/config.fish ]] && ln -sfv ~/.config/Juliet/fish/config.fish ~/.config/fish

  mkdir -p ~/.config/fish/functions
  [[ ! -f ~/.config/fish/functions/fish_user_key_bindings.fish ]] && ln -sfv ~/.config/Juliet/fish/functions/fish_user_key_bindings.fish ~/.config/fish/functions
  [[ ! -f ~/.config/fish/functions/g.fish ]] && ln -sfv ~/.config/Juliet/fish/functions/g.fish ~/.config/fish/functions
  [[ ! -f ~/.config/starship.toml ]] && ln -sfv ~/.config/Juliet/starship.toml ~/.config
  chsh -s /opt/homebrew/bin/fish `whoami`
}

setup_gpg() {
  if [[ ! -d $HOME/.gnupg ]]; then
    mkdir ~/.gnupg
    touch ~/.gnupg/gpg-agent.conf
    echo "pinentry-program /usr/local/bin/pinentry-mac" >> ~/.gnupg/gpg-agent.conf
  fi
}

setup_lua() {
  if ! command -v stylua &> /dev/null; then
    cargo install stylua
  fi
}

setup_kitty() {
  curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
  [[ ! -f /usr/local/bin/kitty ]] && sudo ln -s /Applications/kitty.app/Contents/MacOS/kitty /usr/local/bin

  link_dir kitty ~/.config
  [[ ! -f $HOME/Library/Fonts/3270-nerdfont-complete.ttf ]] && cp $HOME/.config/Juliet/etc/fonts/3270-nerdfont-complete.ttf $HOME/Library/Fonts/
}

setup_other() {
  touch ~/.hushlogin
}

rlog "Setting up git..."
setup_git
rlog "Setting up external dependencies..."
setup_dependencies
log "Installing fzf..."
setup_fzf
log "Installing neovim..."
setup_vim
log "Installing fish..."
setup_fish
log "Installing gpg..."
setup_gpg
log "Installing stylua..."
setup_lua
log "Installing kitty..."
setup_kitty

log "Silencing logins..."
setup_other

log "Done!"
